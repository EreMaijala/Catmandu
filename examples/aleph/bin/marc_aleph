#!/usr/bin/env perl
use Aleph::Record;
use MARC::Batch;
use Getopt::Long;
use Data::Dumper;
use MARC::File::XML ( BinaryEncoding => 'utf8' );
MARC::File::XML->default_record_format('USMARC');

my $fixes = [];

GetOptions("--fix=s@" => \$fixes);

my $file = shift;

die "usage: $0 file" unless $file;

my $batch = MARC::Batch->new('XML', $file);

my $marc;
while ($marc = $batch->next()) {
  my $id    = $marc->field('090')->subfield('a');

  foreach my $fix (@$fixes) {
    eval "$fix;";
    warn "ERROR: $@" if $@;
  }

  my $aleph = Aleph::Record->new(rec => $marc, fmt => 'BK', seq => $id, enc => 'L');
  print $aleph->as_aleph_sequential();
}

sub add_field {
  my $field = MARC::Field->new(@_);
  $marc->append_fields($field);
}
