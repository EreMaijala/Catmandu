#!/bin/bash

PERL="perl"

if [ "${CATMANDU_HOME}" == "" ]; then
    CATMANDU_HOME="../.."
fi

if [ "${ALEPH_HOME}" == "" ]; then
    ALEPH_HOME=${CATMANDU_HOME}/examples/aleph
fi

PROJ=${ALEPH_HOME}

if [ "$1" == "" -o "$2" == "" ]; then
 echo "usage: $0 file type"
 exit 1
fi

FILE="$1"
TYPE="$2"

FILTER="cat"

if [ "$2" == "ejn01" ]; then
  FILTER="${PERL} ${PROJ}/bin/marc2aleph --fix add_field('920','','',a=>'ejournal') /dev/stdin"
fi

zcat ${FILE} | ${FILTER} | \
${PERL} ${CATMANDU_HOME}/bin/catmandu convert \
     -I Aleph -i map=${PROJ}/data/aleph.map  \
     --fix="add_field($.source,'${TYPE}')"  \
     --fix="replace(\$._id,'^','${TYPE}')" \
     --fix="copy_field(\$.fSYS,'${TYPE}')" \
     --fix="join(\$.${TYPE},'')" \
     --fix="${PROJ}/data/aleph.fix" \
     --fix="${PROJ}/data/${TYPE}.fix" \
     --pretty /dev/stdin
