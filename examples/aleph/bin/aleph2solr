#!/bin/bash

PERL="/usr/bin/perl"
CATMANDU=${HOME}/Dev/perl/Catmandu
PROJ=${CATMANDU}/examples/aleph

if [ "$1" == "" -o "$2" == "" ]; then
 echo "usage: $0 file type"
 exit 1
fi

FILE="$1"
TYPE="$2"
MAP="${PROJ}/data/aleph.map"
TYPE_FIX="${PROJ}/data/aleph.fix"

if [ -r "${PROJ}/data/${TYPE}.map" ]; then
  MAP="${PROJ}/data/${TYPE}.map"
fi

if [ -r "${PROJ}/data/${TYPE}.fix" ]; then
  TYPE_FIX=${PROJ}/data/${TYPE}.fix
fi

zcat ${FILE} | \
${PERL} ${CATMANDU}/bin/catmandu index -v \
     -T Solr -t id_field=fSYS \
     -S Catmandu::Importer::Aleph -s map=${MAP} -s file=/dev/stdin \
     --fix="add_field($.source,'${TYPE}')"  \
     --fix="replace(\$.fSYS,'^','${TYPE}:')" \
     --fix="${TYPE_FIX}" 
