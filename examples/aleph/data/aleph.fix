#
# Aleph fix routines
#
# Syntax:
#
#   add_field(path,value)
#   rename_field(old_path,new_path)
#   delete_field(path)
#   substring(path,offset,length)
#   replace(path,search,replace)
#   tolower(path)
#   toupper(path)
#   join(path,expr)
#   lookup(path,config)
#   fix_faculty(path)
#   fix_marcxml(path)
#   fix_impact(path,dest)
#
# Where
#
#   path is a JSON::Path [http://goessner.net/articles/JsonPath/]
#
# $.name        - points to the name field
# $.name.first  - points to the fist subfield of name
# $.title[0]    - points to the first title field
# $..title      - points to all title fields
#
# P@ 2011-02
# 

# Parse the dates and languages
substring($.year,7,4)
substring($.period,7,2)
substring($.lang,35,3)
replace($.year,'\^','0')
replace($.period,'\^','0')
replace($.lang,'\^','x')

# Create sort titles of max 80 characters all lowercase no space or special characters
substring($.title_sort,0,80)
tolower($.title_sort)
replace($.title_sort,'[^a-z0-9]','')

# Special fixes needed to parse faculty out of holding
fix_faculty($.faculty)

# Lookup journal impact factor
fix_impact($._issn,'impact')
fix_holding($.holding,'holding','holding_txt')

# Transform field into MARCML
fix_marcxml($.fXML)

# Do some cleaning for the indexes..some fields can't be multi-valued
# we need to 'join' all values
join($.all,' ')
join($.bak,' ')
join($.barcode,' ')
join($.cid,' ')
join($.collection,' ')
join($.department,' ')
join($.fDATE,' ')
join($.fSYS,' ')
join($.fXML,' ')
join($.faculty,' ')
join($.holding, ' ')
join($.impact,' ')
join($.lang,' ')
join($.library, ' ')
join($.location,' ')
join($.period,' ')
join($.perm,' ')
join($.status,' ')
join($.title,' ')
join($.title_sort,' ')
join($.type,' ')
join($.year,' ')

delete_field($._id)
delete_field($._issn)
